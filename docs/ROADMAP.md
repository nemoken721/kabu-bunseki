# 10年長期分析＆AI予測レポート生成 Webアプリケーション 開発ロードマップ

## 技術スタック

| レイヤー | 技術 | 用途 |
|---------|------|------|
| **フロントエンド** | Next.js (App Router) | React フレームワーク、SSR/SSG |
| **バックエンド** | Python (FastAPI) | データ処理、AI分析エンジン |
| **データベース** | Supabase (PostgreSQL) | データ永続化、リアルタイム機能 |
| **認証** | Supabase Auth | ユーザー認証・セッション管理 |
| **ホスティング** | Vercel | Next.js デプロイ、CDN、Edge Functions |
| **AI** | Google Gemini 2.5 Flash | レポート生成 |

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                          Vercel                                  │
│              (Hosting / CDN / Edge Network)                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 Next.js (App Router)                     │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │    │
│  │  │  Server      │  │   API        │  │  Static      │   │    │
│  │  │  Components  │  │   Routes     │  │  Assets      │   │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
          │                      │
          │                      ▼
          │         ┌────────────────────────┐
          │         │   Python Backend       │
          │         │   (外部サーバー)       │
          │         │  ・EDINET連携          │
          │         │  ・データ分析          │
          │         │  ・AI統合              │
          │         └────────────────────────┘
          │                      │
          ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Supabase                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  PostgreSQL  │  │  Auth        │  │  Row Level Security  │   │
│  │  Database    │  │  (認証)      │  │  (RLS)               │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## フェーズ概要

```
Phase 1: 基盤構築・認証     ████████░░░░░░░░░░░░
Phase 2: データ取得         ░░░░░░░░████████░░░░
Phase 3: 分析エンジン       ░░░░░░░░░░░░░░██████
Phase 4: AI統合             ░░░░░░░░░░░░░░░░████
Phase 5: UI/UX・ユーザー機能 ░░░░░░░░░░░░░░░░░░██
Phase 6: 本番デプロイ       ░░░░░░░░░░░░░░░░░░░█
```

---

## Phase 1: 基盤構築・認証

### 1.1 プロジェクト設定
- [x] バックエンド ディレクトリ構成の作成
- [x] Python仮想環境のセットアップ
- [x] Python依存ライブラリのインストール
- [ ] Next.js プロジェクト初期化 (`frontend/`)
- [ ] 環境変数設定（`.env.local`, `.env.example`）
- [ ] Git初期化・`.gitignore` 設定
- [ ] monorepo構成の整備

### 1.2 Supabase セットアップ
- [ ] Supabase プロジェクト作成
- [ ] データベーススキーマ設計
  - [ ] `profiles` テーブル（ユーザープロファイル）
  - [ ] `companies` テーブル（企業マスタ）
  - [ ] `financial_statements` テーブル（財務データ）
  - [ ] `stock_prices` テーブル（株価データ）
  - [ ] `analysis_reports` テーブル（AI生成レポート）
  - [ ] `user_watchlists` テーブル（ウォッチリスト）
- [ ] Row Level Security (RLS) ポリシー設定
- [ ] Database Functions / Triggers 設定

### 1.3 認証システム（Supabase Auth）
- [ ] Supabase Auth 設定
  - [ ] メール/パスワード認証
  - [ ] Google OAuth（オプション）
  - [ ] GitHub OAuth（オプション）
- [ ] Next.js への Supabase クライアント統合
- [ ] 認証ミドルウェア実装
- [ ] ログイン/サインアップページ
- [ ] パスワードリセット機能
- [ ] メール確認フロー

### 1.4 Next.js 基盤
- [ ] App Router 構成
- [ ] Tailwind CSS セットアップ
- [ ] shadcn/ui コンポーネント導入
- [ ] レイアウト設計（Header, Sidebar, Footer）
- [ ] ローディング/エラー状態のUI

### 1.5 バックエンドAPI基盤
- [ ] FastAPI アプリケーション初期化
- [ ] Supabase クライアント（Python）設定
- [ ] JWT検証ミドルウェア（Supabase Auth連携）
- [ ] CORS設定（Vercel ドメイン許可）
- [ ] エラーハンドリング共通化
- [ ] ヘルスチェックエンドポイント

---

## Phase 2: データ取得機能

### 2.1 EDINET連携（F-01: 10年分財務データ取得）
- [ ] EDINET API クライアント実装
  - [ ] 書類一覧取得API
  - [ ] 書類取得API
  - [ ] レート制限対応
- [ ] XBRLパーサー実装
  - [ ] 損益計算書（PL）データ抽出
  - [ ] 貸借対照表（BS）データ抽出
  - [ ] キャッシュフロー計算書（CF）データ抽出
  - [ ] MD&A（経営者による分析）抽出
- [ ] 会計基準変更対応（F-03）
  - [ ] 日本基準/IFRS判定ロジック
  - [ ] データ正規化処理

### 2.2 株価データ取得（F-02: 長期株価データ取得）
- [ ] pandas-datareader経由のデータ取得
  - [ ] Stooq対応
  - [ ] Yahoo Finance対応（バックアップ）
- [ ] 日足/週足/月足変換
- [ ] 株式分割・併合調整

### 2.3 データ統合・保存
- [ ] 財務データと株価データの時系列マッチング
- [ ] Supabase へのデータ保存
- [ ] バッチ処理（Vercel Cron Jobs or 外部）
- [ ] データ更新差分検知

---

## Phase 3: 分析エンジン

### 3.1 特徴量エンジニアリング（技術課題6.1対応）
- [ ] 財務指標計算
  - [ ] ROE/ROA/営業利益率
  - [ ] 成長率（売上/利益）
  - [ ] 負債比率
- [ ] 株価指標計算
  - [ ] PER/PBR
  - [ ] ボラティリティ
  - [ ] 移動平均乖離率
- [ ] 相関分析
  - [ ] 業績と株価の相関係数
  - [ ] 為替・市場指標との相関

### 3.2 統計分析サービス
- [ ] 10年間トレンド分析
- [ ] 景気サイクル判定
- [ ] 業績発表前後の株価変動パターン分析
- [ ] 異常値検出

### 3.3 サマリデータ生成（LLM用）
- [ ] トークン効率を考慮したデータ圧縮
- [ ] 重要指標の自動抽出
- [ ] 時系列サマリ生成

---

## Phase 4: AI統合

### 4.1 LLM統合基盤
- [ ] Google Gemini API クライアント実装
- [ ] プロンプトテンプレート管理
- [ ] トークン数カウント・制御
- [ ] ストリーミングレスポンス対応

### 4.2 レポート生成機能（F-07, F-08）
- [ ] システムプロンプト設計
  - [ ] 過去分析プロンプト
  - [ ] 特徴抽出プロンプト
  - [ ] 未来予測プロンプト
  - [ ] 根拠提示プロンプト
- [ ] 免責事項自動付与（技術課題6.3対応）
- [ ] 推測表現への自動変換

### 4.3 レポートキャッシュ・課金対策
- [ ] 生成レポートの Supabase 保存
- [ ] キャッシュ有効期限管理
- [ ] ユーザーごとのAPI使用量追跡

---

## Phase 5: UI/UX・ユーザー機能

### 5.1 銘柄検索機能
- [ ] 検索窓コンポーネント（コマンドパレット風）
- [ ] オートコンプリート（Supabase full-text search）
- [ ] 銘柄コード/企業名検索
- [ ] 最近検索した銘柄

### 5.2 ダッシュボード（F-04, F-05, F-06）
- [ ] メインチャートエリア
  - [ ] 株価チャート（Recharts or TradingView）
  - [ ] 売上高/営業利益オーバーレイ
  - [ ] 会計基準変更の区切り線表示
- [ ] 年度コントロール
  - [ ] スライダーUI
  - [ ] ドロップダウン切替
- [ ] 詳細情報エリア
  - [ ] PL/BS/CF表示
  - [ ] MD&A要約表示
  - [ ] 主要指標カード

### 5.3 AI分析レポートUI（F-07, F-08）
- [ ] 分析実行ボタン
- [ ] ストリーミング表示（リアルタイムタイピング風）
- [ ] レポート表示エリア
  - [ ] 株価推移の特徴セクション
  - [ ] 今後の予測シナリオセクション
  - [ ] 根拠セクション
- [ ] レポートエクスポート（PDF/Markdown）

### 5.4 ユーザー機能
- [ ] ウォッチリスト機能
  - [ ] 銘柄の追加/削除
  - [ ] 一覧表示
- [ ] 過去レポート履歴
- [ ] ユーザー設定ページ
  - [ ] プロファイル編集
  - [ ] 通知設定

### 5.5 レスポンシブ対応
- [ ] モバイル対応レイアウト
- [ ] タブレット対応
- [ ] ダークモード対応

---

## Phase 6: 本番デプロイ・運用

### 6.1 Vercel デプロイ設定
- [ ] Vercel プロジェクト作成
- [ ] 環境変数設定
- [ ] ビルド設定最適化
- [ ] Preview デプロイ設定

### 6.2 ドメイン設定
- [ ] カスタムドメイン設定（Vercel）
- [ ] SSL/TLS設定（自動）

### 6.3 Python バックエンドデプロイ
- [ ] デプロイ先選定
  - [ ] オプション A: Railway
  - [ ] オプション B: Render
- [ ] 環境変数・シークレット管理
- [ ] スケーリング設定

### 6.4 パフォーマンス最適化
- [ ] Next.js ISR/SSG 活用
- [ ] Supabase インデックス最適化
- [ ] Edge Caching 設定
- [ ] 画像最適化（next/image）

### 6.5 監視・運用
- [ ] Vercel Analytics 設定
- [ ] エラー監視（Sentry 等）
- [ ] Supabase ダッシュボード監視
- [ ] アラート設定

### 6.6 セキュリティ
- [ ] RLS ポリシーの徹底確認
- [ ] API レート制限
- [ ] 入力バリデーション強化
- [ ] CSP ヘッダー設定

### 6.7 テスト
- [ ] ユニットテスト（Jest / Vitest）
- [ ] 統合テスト（Playwright）
- [ ] APIテスト（pytest）
- [ ] 負荷テスト

---

## 技術的依存関係

```
Phase 1 (認証・基盤)
    │
    ├──> Phase 2 (データ取得)
    │        │
    │        ▼
    │    Phase 3 (分析エンジン)
    │        │
    │        ▼
    │    Phase 4 (AI統合)
    │
    └──> Phase 5 (UI/UX) ──────────────┐
                                        │
                                        ▼
                                   Phase 6 (デプロイ)
```

**クリティカルパス:**
1. Supabase設計 → 認証実装 → データ取得 → 分析エンジン → AI統合 → 本番デプロイ

---

## ディレクトリ構成（更新版）

```
kabu-bunseki/
├── frontend/                    # Next.js アプリケーション
│   ├── app/                     # App Router
│   │   ├── (auth)/              # 認証関連ページ
│   │   │   ├── login/
│   │   │   └── signup/
│   │   ├── (dashboard)/         # 認証必須ページ
│   │   │   ├── analysis/[code]/ # 銘柄分析ページ
│   │   │   ├── watchlist/
│   │   │   └── settings/
│   │   ├── api/                 # API Routes
│   │   ├── layout.tsx
│   │   └── page.tsx             # ランディングページ
│   ├── components/
│   │   ├── ui/                  # shadcn/ui
│   │   ├── charts/              # チャートコンポーネント
│   │   └── features/            # 機能別コンポーネント
│   ├── lib/
│   │   ├── supabase/            # Supabase クライアント
│   │   └── utils/
│   ├── hooks/
│   └── types/
│
├── backend/                     # Python バックエンド
│   ├── app/
│   │   ├── api/
│   │   │   └── endpoints/
│   │   ├── services/
│   │   │   ├── edinet/          # EDINET連携
│   │   │   ├── stock/           # 株価取得
│   │   │   ├── analysis/        # 分析エンジン
│   │   │   └── ai/              # AI統合
│   │   ├── models/
│   │   └── config/
│   ├── tests/
│   └── requirements.txt
│
├── supabase/                    # Supabase設定
│   ├── migrations/              # DBマイグレーション
│   └── seed.sql                 # 初期データ
│
├── docs/
│   └── ROADMAP.md
│
└── .github/
    └── workflows/               # CI/CD
```

---

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| EDINETで5年以上前のデータが取得不可 | 高 | 取得可能期間で分析する仕様とする |
| LLMトークン制限超過 | 中 | 事前に特徴量を計算しサマリ化 |
| 投資助言規制リスク | 高 | 免責事項自動付与、推測表現統一 |
| Supabase 無料枠超過 | 中 | 使用量監視、Pro プラン検討 |
| Vercel 関数タイムアウト（10秒） | 中 | 重い処理は外部バックエンドへ分離 |
| Gemini APIコスト増大 | 中 | レポートキャッシュ、使用量制限（Flashは低コスト） |

---

## 次のアクション

**Phase 1 で最初に着手すべきタスク:**

1. **Supabase プロジェクト作成**
   - ダッシュボードでプロジェクト作成
   - API キー取得

2. **Next.js プロジェクト初期化**
   ```bash
   cd frontend
   npx create-next-app@latest . --typescript --tailwind --eslint --app
   ```

3. **環境変数ファイル作成**
   - `.env.local` / `.env.example`
   - Supabase URL, Anon Key 設定

4. **Git リポジトリ初期化**
   - `.gitignore` 設定
   - 初回コミット

5. **Supabase Auth 設定**
   - 認証プロバイダー有効化
   - Next.js への統合

---

*最終更新: 2025年12月25日*
